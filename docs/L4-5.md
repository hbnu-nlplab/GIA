# L4/L5 문제 정의 및 Batfish 구현 가이드

## 개요

이 문서는 네트워크 엔지니어링 Q&A 데이터셋 생성을 위한 L4(네트워크 도달성) 및 L5(What-If/Differential 분석) 레벨 문제의 정의와 Batfish를 활용한 구현 방법을 설명합니다.

## 레벨 정의

### L4: 네트워크 흐름 도달성 (Network Flow Reachability)
특정 트래픽이 네트워크를 통해 목적지에 도달할 수 있는지 분석하는 문제입니다. ACL, 방화벽, 라우팅 정책 등의 영향을 고려합니다.

### L5: What-If / Differential 분석 (What-If/Differential Analysis)
네트워크 변경 시나리오(링크 장애, 설정 변경 등)의 영향을 분석하고, 변경 전후의 차이를 비교하는 문제입니다.

## L4 문제 예시

### 1. 기본 도달성 분석 (Basic Reachability)

**질문 예시:**
```
Host A(192.168.1.10)에서 CE1(10.0.0.1)로의 TCP/22(SSH) 트래픽이 도달 가능한가요?
[답변 형식: boolean]
```

**Batfish API:**
```python
from pybatfish.client.session import Session
from pybatfish.datamodel.flow import HeaderConstraints

bf = Session(host='localhost')
bf.init_snapshot('network_snapshot')

result = bf.q.reachability(
    pathConstraints=PathConstraints(
        startLocation='Host_A',
        endLocation='CE1'
    ),
    headers=HeaderConstraints(
        srcIps='192.168.1.10',
        dstIps='10.0.0.1',
        ipProtocols=['TCP'],
        dstPorts=['22']
    )
).answer().frame()
```

**정답 형식:**
- `true`: 도달 가능
- `false`: 도달 불가능

### 2. 경로 추적 분석 (Path Tracing)

**질문 예시:**
```
PE1에서 CE2로 가는 패킷의 네트워크 경로를 알려주세요.
[답변 형식: set]
```

**Batfish API:**
```python
traceroute = bf.q.traceroute(
    startLocation='PE1',
    headers=HeaderConstraints(dstIps='CE2_IP')
).answer().frame()

# 경로 추출
path = []
for hop in traceroute['Traces'].iloc[0][0]['hops']:
    path.append(hop['node']['name'])
```

**정답 형식:**
- `["PE1", "P1", "P2", "PE2"]`

### 3. ACL 차단 지점 분석 (ACL Blocking Point)

**질문 예시:**
```
Host A에서 Web Server(192.168.2.100:80)로의 HTTP 트래픽이 차단되는 지점을 알려주세요.
[답변 형식: text]
```

**Batfish API:**
```python
reachability = bf.q.reachability(
    headers=HeaderConstraints(
        srcIps='Host_A_IP',
        dstIps='192.168.2.100',
        dstPorts=['80'],
        ipProtocols=['TCP']
    )
).answer().frame()

# 차단된 경우 blocking ACL 정보 추출
if not reachability['Flow'].empty:
    blocking_acl = reachability['BlockingACL'].iloc[0]
    blocking_line = reachability['BlockingLine'].iloc[0]
```

**정답 형식:**
- `"Router R1의 ACL 'DENY_HTTP'의 라인 10"`

## L5 문제 예시

### 1. 링크 장애 영향 분석 (Link Failure Impact)

**질문 예시:**
```
PE1과 P1 사이의 링크가 다운되었을 때, Host A에서 Host B로의 트래픽에 영향이 있나요?
[답변 형식: boolean]
```

**Batfish API:**
```python
# 기준 스냅샷 (정상 상태)
bf.init_snapshot('baseline', name='before')

# 링크 다운 시나리오
bf.init_snapshot('link_down_config', name='after')

# 차이 분석
diff = bf.q.differentialReachability(
    snapshot='after',
    reference_snapshot='before',
    headers=HeaderConstraints(
        srcIps='Host_A_IP',
        dstIps='Host_B_IP'
    )
).answer().frame()

# 영향 분석
has_impact = not diff.empty and len(diff) > 0
```

**정답 형식:**
- `true`: 영향 있음
- `false`: 영향 없음

### 2. 설정 변경 영향 분석 (Configuration Change Impact)

**질문 예시:**
```
Router R1에 새로운 ACL 규칙을 추가했을 때, 어떤 트래픽 흐름에 영향이 있나요?
[답변 형식: set]
```

**Batfish API:**
```python
# 변경 전후 스냅샷 비교
diff_analysis = bf.q.differentialReachability(
    snapshot='after_change',
    reference_snapshot='before_change'
).answer().frame()

# 영향받는 트래픽 목록 추출
affected_flows = set()
for _, row in diff_analysis.iterrows():
    flow_desc = f"{row['SrcIp']} -> {row['DstIp']}:{row['DstPort']}"
    affected_flows.add(flow_desc)
```

**정답 형식:**
- `["192.168.1.10 -> 10.0.0.1:80", "192.168.1.20 -> 10.0.0.2:443"]`

### 3. 정책 준수 검증 (Policy Compliance Check)

**질문 예시:**
```
네트워크가 '모든 웹 트래픽은 방화벽을 통과해야 한다'는 정책을 준수하고 있나요?
[답변 형식: boolean]
```

**Batfish API:**
```python
# 정책 위반 트래픽 탐지
policy_violations = bf.q.reachability(
    headers=HeaderConstraints(
        dstPorts=['80', '443'],
        ipProtocols=['TCP']
    ),
    pathConstraints=PathConstraints(
        forbiddenLocations=['Firewall']  # 방화벽을 통과하지 않는 경로
    )
).answer().frame()

# 정책 준수 여부 판단
is_compliant = policy_violations.empty
```

**정답 형식:**
- `true`: 정책 준수
- `false`: 정책 위반

## Batfish API 매핑 표

| 문제 유형 | Batfish Query | 주요 파라미터 | 반환 데이터 |
|----------|---------------|---------------|-------------|
| 기본 도달성 | `reachability()` | `headers`, `pathConstraints` | Flow, Traces |
| 경로 추적 | `traceroute()` | `startLocation`, `headers` | Traces, Hops |
| 차이 분석 | `differentialReachability()` | `snapshot`, `reference_snapshot` | Flow differences |
| 인터페이스 속성 | `interfaceProperties()` | `nodes` | Interface details |
| 라우팅 테이블 | `routes()` | `nodes` | Routing entries |
| ACL 분석 | `filterLineReachability()` | `filters` | ACL rule matches |

## 구현 고려사항

### 1. 스냅샷 관리
```python
# 기준 스냅샷 생성
bf.init_snapshot('baseline_configs/', name='baseline')

# 변경 시나리오 스냅샷 생성
bf.init_snapshot('modified_configs/', name='scenario1')
```

### 2. 헤더 제약 조건
```python
from pybatfish.datamodel.flow import HeaderConstraints

headers = HeaderConstraints(
    srcIps=['192.168.1.0/24'],
    dstIps=['10.0.0.0/8'],
    ipProtocols=['TCP'],
    srcPorts=['1024-65535'],
    dstPorts=['80', '443']
)
```

### 3. 경로 제약 조건
```python
from pybatfish.datamodel.flow import PathConstraints

path_constraints = PathConstraints(
    startLocation='Host_A',
    endLocation='Web_Server',
    transitLocations=['Firewall'],  # 반드시 통과해야 하는 노드
    forbiddenLocations=['Old_Router']  # 통과하면 안 되는 노드
)
```

## 추가 문제 유형 제안

### L1-L3 보완 (✅ 구현 완료)
- **L1**: NTP 서버(`ntp_server_list`), SNMP 커뮤니티(`snmp_community_list`), Syslog 서버(`syslog_server_list`) 설정
- **L2**: 동일 VRF 장비 그룹(`devices_with_same_vrf`), OSPF Area 멤버십(`ospf_area_membership`)
- **L3**: iBGP Full-Mesh 검증, L2VPN 일관성 검증, VRF RT 일관성 검증

### L4-L5 확장 제안
- 멀티패스 라우팅 분석
- QoS 정책 영향 평가
- VPN 터널 도달성 검증
- 보안 정책 영향 분석

## 구현 상태

### ✅ 완료된 작업

1. **L4/L5 엔진 개발**: `Make_Dataset/src/core/batfish_builder.py` 생성
2. **통합 파이프라인**: `main.py`에 `--enable-batfish` 옵션 추가
3. **L4 메트릭 구현**:
   - `traceroute_path`: 네트워크 경로 추적
   - `reachability_status`: 도달 가능 여부
   - `acl_blocking_point`: ACL 차단 지점
4. **L5 메트릭 구현**:
   - `link_failure_impact`: 링크 장애 영향 분석
   - `config_change_impact`: 설정 변경 영향 분석
   - `policy_compliance_check`: 정책 준수 검증

### 사용 방법

```bash
# Batfish 서버 실행 (Docker)
docker run -d -p 9996:9996 -p 9997:9997 batfish/allinone

# L4/L5 문제 포함 데이터셋 생성
cd Make_Dataset/src
python main.py \
  --xml-dir ../data/raw/XML_Data \
  --output-dir ../data/processed \
  --enable-batfish \
  --snapshot-path /path/to/configs
```

### 다음 단계

1. **정답 검증**: 생성된 문제의 정답 정확성 검증
2. **더 큰 토폴로지**: BGP/OSPF/VRF가 설정된 실험실 사용
3. **시나리오 확장**: 다양한 장애/변경 시나리오 추가
